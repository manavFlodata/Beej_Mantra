<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroTech - Field Advisory Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="dashboard-styles.css" />
    
     
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://unpkg.com/plotty@0.4.4/dist/plotty.min.js"></script>

<script src="https://unpkg.com/geotiff/dist/geotiff.browser.min.js"></script>

<script src="https://unpkg.com/leaflet-geotiff/dist/leaflet-geotiff.min.js"></script>

<script src="https://unpkg.com/leaflet-geotiff/dist/leaflet-geotiff-plotty.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- HEADER -->
        <header class="dashboard-header">
            <div class="header-content">
                <h1 class="header-title">üåæ Beej Mantra</h1>
                <p class="header-subtitle">Agritech-based intelligence platform</p>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- MAP SECTION -->
            <div class="map-section">
                <div id="map"></div>
                <div class="map-overlay">
                    <h2>üìç DEVLIYA, JAIPUR</h2>
                    <p>Rajasthan, India ‚Ä¢ 27.118¬∞N, 75.441¬∞E</p>
                </div>
            </div>

            <!-- CONTENT GRID -->
            <div class="content-grid">
                <!-- LEFT: FIELD CONTEXT -->
                <div>
                    <div class="card">
                        <h3>üå± Field Summary</h3>
                        <div class="field-info">
                            <div class="info-row">
                                <span class="label">Field ID</span>
                                <span class="value">DEVLIYA_01</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Crop</span>
                                <span class="value">Wheat</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Area</span>
                                <span class="value">0.44 ha</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Irrigation</span>
                                <span class="value">Flood <span class="assumed">(assumed)</span></span>
                            </div>
                            <div class="info-row">
                                <span class="label">Soil</span>
                                <span class="value">Loam <span class="assumed">(assumed)</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- CROP HEALTH -->
                    <div class="card">
                        <h3>üõ∞Ô∏è Crop Health</h3>
                        <div class="health-status">
                            <div class="ndvi-value">0.72</div>
                            <div class="health-badge healthy">Healthy</div>
                            <div class="health-date">Last updated: Jan 28, 2025</div>
                        </div>
                        <div class="ndvi-legend">
                            <div class="legend-item">
                                <span class="legend-color" style="background: #d73027"></span>
                                <span>Stressed (&lt;0.4)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background: #fee08b"></span>
                                <span>Moderate (0.4-0.6)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background: #1a9850"></span>
                                <span>Healthy (&gt;0.6)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CENTER: SCIENCE STACK -->
                <div class="science-stack">
                    <!-- WEATHER -->
                    <div class="card">
                        <h3>üå¶Ô∏è 7-Day Weather Forecast</h3>
                        <div class="weather-grid">
                            <div class="weather-day">
                                <div class="date">Jan 31</div>
                                <div class="icon">‚òÄÔ∏è</div>
                                <div class="temp">30¬∞ / 15¬∞</div>
                                <div class="rain">0 mm</div>
                            </div>
                            <div class="weather-day">
                                <div class="date">Feb 1</div>
                                <div class="icon">‚òÄÔ∏è</div>
                                <div class="temp">32¬∞ / 14¬∞</div>
                                <div class="rain">0 mm</div>
                            </div>
                            <div class="weather-day">
                                <div class="date">Feb 2</div>
                                <div class="icon">üå§Ô∏è</div>
                                <div class="temp">28¬∞ / 13¬∞</div>
                                <div class="rain">0 mm</div>
                            </div>
                            <div class="weather-day">
                                <div class="date">Feb 3</div>
                                <div class="icon">üåßÔ∏è</div>
                                <div class="temp">26¬∞ / 12¬∞</div>
                                <div class="rain">2 mm</div>
                            </div>
                            <div class="weather-day">
                                <div class="date">Feb 4</div>
                                <div class="icon">‚òÄÔ∏è</div>
                                <div class="temp">29¬∞ / 13¬∞</div>
                                <div class="rain">0 mm</div>
                            </div>
                            <div class="weather-day">
                                <div class="date">Feb 5</div>
                                <div class="icon">‚òÄÔ∏è</div>
                                <div class="temp">31¬∞ / 14¬∞</div>
                                <div class="rain">0 mm</div>
                            </div>
                            <div class="weather-day">
                                <div class="date">Feb 6</div>
                                <div class="icon">üå§Ô∏è</div>
                                <div class="temp">30¬∞ / 13¬∞</div>
                                <div class="rain">0 mm</div>
                            </div>
                        </div>
                    </div>

                    <!-- ETO -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-title">üíß Evapotranspiration</span>
                            <span class="tooltip-icon" title="Water lost due to weather">‚ÑπÔ∏è</span>
                        </div>
                        <div class="metric-value">6.2</div>
                        <div class="metric-label">mm/day - Reference ET‚ÇÄ</div>
                    </div>

                    <!-- CROP WATER REQUIREMENT -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-title">üåæ Crop Water Requirement</span>
                        </div>
                        <div class="calc-row">
                            <span>ET‚ÇÄ:</span>
                            <strong>6.2 mm</strong>
                        </div>
                        <div class="calc-row">
                            <span>Kc (Mid-season):</span>
                            <strong>1.15</strong>
                        </div>
                        <div class="calc-row result">
                            <span>ETc:</span>
                            <strong>7.1 mm/day</strong>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: DECISION PANEL -->
                <div class="decision-panel">
                    <h2>üöø Irrigation Advisory</h2>
                    
                    <div class="advisory-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>ETc</th>
                                    <th>Rain</th>
                                    <th>Irrigate</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="highlight">
                                    <td>Feb 1</td>
                                    <td>7.1mm</td>
                                    <td>0mm</td>
                                    <td><strong>25mm</strong></td>
                                    <td><span class="badge irrigate">Irrigate</span></td>
                                </tr>
                                <tr>
                                    <td>Feb 2</td>
                                    <td>7.3mm</td>
                                    <td>0mm</td>
                                    <td>-</td>
                                    <td><span class="badge skip">Skip</span></td>
                                </tr>
                                <tr>
                                    <td>Feb 3</td>
                                    <td>6.8mm</td>
                                    <td>2mm</td>
                                    <td>-</td>
                                    <td><span class="badge skip">Skip</span></td>
                                </tr>
                                <tr class="highlight">
                                    <td>Feb 4</td>
                                    <td>7.0mm</td>
                                    <td>0mm</td>
                                    <td><strong>25mm</strong></td>
                                    <td><span class="badge irrigate">Irrigate</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="runtime-card">
                        <h3>‚è±Ô∏è Pump Runtime</h3>
                        <div class="runtime-calc">
                            <div class="runtime-row">
                                <span>Irrigation needed:</span>
                                <strong>25 mm</strong>
                            </div>
                            <div class="runtime-row">
                                <span>Application rate:</span>
                                <strong>12 mm/hr</strong>
                                <span class="assumed">(assumed)</span>
                            </div>
                        </div>
                        <div class="runtime-result">
                            <div class="runtime-value">2h 5m</div>
                            <div class="runtime-label">Run pump for</div>
                        </div>
                    </div>

                    <!-- <div class="ai-explanation">
                        <h3>ü§ñ Why This Recommendation?</h3>
                        <p>High temperature (32¬∞C) and no rainfall are increasing crop water demand. The wheat crop is in mid-season growth stage with peak water requirements. Irrigating tomorrow morning will maintain optimal soil moisture.</p>
                    </div>

                    <div class="assumptions">
                        <details>
                            <summary>‚ö†Ô∏è Assumptions & Disclaimers</summary>
                            <ul>
                                <li>Soil type (Loam) assumed based on regional data</li>
                                <li>No soil moisture sensors connected</li>
                                <li>Irrigation efficiency assumed at 75%</li>
                                <li>Weather forecast from public sources</li>
                                <li>Advisory based on publicly available satellite data</li>
                            </ul>
                        </details>
                    </div> -->
                </div>
            </div>

            <!-- LINE CHART SECTION -->
            <div class="chart-section">
                <div class="chart-header">
                    <h3>Weather Data Trends (2019-2024)</h3>
                    <div class="chart-controls">
                        <h4>Select Columns</h4>
                        <div class="column-checkboxes">
                            <label class="checkbox-item">
                                <input type="checkbox" value="temperature" checked>
                                <span class="checkbox-label" style="--color: #e53e3e;">Temperature (¬∞C)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="humidity" checked>
                                <span class="checkbox-label" style="--color: #3182ce;">Humidity (%)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="precipitation">
                                <span class="checkbox-label" style="--color: #38a169;">Precipitation (mm)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="rain">
                                <span class="checkbox-label" style="--color: #667eea;">Rain (mm)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="wind_speed">
                                <span class="checkbox-label" style="--color: #805ad5;">Wind Speed (km/h)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="cloud_cover">
                                <span class="checkbox-label" style="--color: #718096;">Cloud Cover (%)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="evapotranspiration">
                                <span class="checkbox-label" style="--color: #d69e2e;">ET0 (mm)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="pressure">
                                <span class="checkbox-label" style="--color: #ed8936;">Pressure (hPa)</span>
                            </label>
                        </div>
                        <div class="date-range-controls">
                            <h4>Select Date Range</h4>
                            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                                <label>From: <input type="month" id="startMonth"></label>
                                <label>To: <input type="month" id="endMonth"></label>
                                <button id="applyRange">Apply</button>
                                <button class="period-btn" data-period="year" id="resetRange">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-container" style="display:flex;gap:16px;align-items:flex-start;">
                    <div class="chart-wrapper" style="flex:1 1 auto;">
                        <canvas id="weatherChart"></canvas>
                    </div>
                    <div id="chartStats" class="chart-stats" style="min-width:220px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:12px;box-shadow:var(--shadow-sm);">
                        <h4 style="margin:0 0 8px 0;color:#2d3748;">Range Stats</h4>
                        <div id="statsContent" style="font-size:12px;color:#4a5568;">No data</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Wait for page to fully load
        let agricultureTifLayer = null;
let yearControl = null;
// let waterYearControl = null;
let agricultureYearControl = null;
let waterYearControl = null;


function loadAgricultureTif(filename) {
    const PlottyRenderer =
        (L.LeafletGeotiff && L.LeafletGeotiff.plotty) ||
        L.LeafletGeotiffPlotty;

    if (!PlottyRenderer) {
        console.error('Leaflet GeoTIFF Plotty not available');
        return;
    }

    if (agricultureTifLayer) {
        map.removeLayer(agricultureTifLayer);
        agricultureTifLayer = null;
    }

    const tifPath = `./agriculture/${filename}`;

    agricultureTifLayer = L.leafletGeotiff(tifPath, {
        renderer: new PlottyRenderer({
            colorScale: 'rdylgn',
            clampLow: false,
            clampHigh: false
        }),
        opacity: 0.7
    });

    agricultureTifLayer.addTo(map);
}

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map centered on Devliya, Jaipur
            // Devliya coordinates: 27.11798786379071¬∞ N, 75.44081379398433¬∞ E
            const map = L.map('map', {
                center: [27.11798786379071, 75.44081379398433],
                zoom: 15,
                minZoom: 10,
                maxZoom: 21,
                scrollWheelZoom: true,
                dragging: true
            });

            // Add satellite base layer
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 21,
                maxNativeZoom: 18
            });

            // Add OpenStreetMap layer
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 21,
                maxNativeZoom: 19,
                subdomains: ['a', 'b', 'c'],
                crossOrigin: true
            });

            // Add Google Satellite layer
            const googleSatellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: '¬© Google',
                maxZoom: 21,
                maxNativeZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            });

            // Add satellite layer first (Esri by default)
            satelliteLayer.addTo(map);

            // Create base layers object
            const baseLayers = {
                "üõ∞Ô∏è Esri Satellite": satelliteLayer,
                "üåç Google Satellite": googleSatellite,
                "üó∫Ô∏è OpenStreetMap": osmLayer
            };

            // Create street labels overlay
            const streetLabels = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                opacity: 0.3,
                maxZoom: 21,
                maxNativeZoom: 19
            });

            // Create agriculture layer group
            const agricultureLayerGroup = L.layerGroup();

            // Create water layer group
            const waterLayerGroup = L.layerGroup();

            // Create overlay layers object
            const overlayLayers = {
                "üè∑Ô∏è Street Labels": streetLabels,
                "üåæ Agriculture Data": agricultureLayerGroup,
                "üíß Water Data": waterLayerGroup
            };

            // Add layer control to the map
            const layerControl = L.control.layers(baseLayers, overlayLayers, {
                position: 'topright',
                collapsed: false
            }).addTo(map);


            // Add error handling for tile loading and update boundary on layer change
            map.on('baselayerchange', function(e) {
                console.log('Base layer changed to:', e.name);

                // Remove old boundary
                map.removeLayer(normalPolygon);

                // Select appropriate boundary coordinates based on layer
                if (e.name === 'üåç Google Satellite') {
                    currentBoundary = fieldBoundaryGoogle;
                } else {
                    // Esri Satellite and OpenStreetMap use default coordinates
                    currentBoundary = fieldBoundaryDefault;
                }

                // Add new boundary with updated coordinates
                normalPolygon = L.polygon(currentBoundary, {
                    color: '#667eea',
                    fillColor: '#667eea',
                    fillOpacity: 0.4,
                    weight: 3
                }).addTo(map);

                // Re-bind popup to new polygon
                normalPolygon.bindPopup(`
                    <div style="font-family: sans-serif; min-width: 200px;">
                        <strong style="font-size: 15px; color: #2d3748;">Field: DEVLIYA_01</strong><br><br>
                        <strong>Crop:</strong> Wheat üåæ<br>
                        <strong>Area:</strong> 0.44 hectares<br>
                        <strong>Location:</strong> Devliya, Jaipur<br>
                        <strong>NDVI:</strong> 0.72 (Healthy) üü¢
                    </div>
                `);
            });

            // Listen for tile load errors
            map.on('tileerror', function(error, tile) {
                console.error('Tile failed to load:', error);
            });

            // Handle agriculture layer toggle
            map.on('overlayadd', function(e) {
                if (e.name === 'üåæ Agriculture Data') {
                    console.log('Agriculture layer added');
                    loadAgricultureData();
                }
            });

            map.on('overlayremove', function(e) {
                if (e.name === 'üåæ Agriculture Data') {
                    console.log('Agriculture layer removed');
                    agricultureLayerGroup.clearLayers();
if (agricultureYearControl) {
            map.removeControl(agricultureYearControl);
            agricultureYearControl = null;
        }
        
                }
            });

            // Handle water layer toggle
            map.on('overlayadd', function(e) {
                if (e.name === 'üíß Water Data') {
                    console.log('Water layer added');
                    loadWaterData();
                }
            });

            map.on('overlayremove', function(e) {
                if (e.name === 'üíß Water Data') {
                    console.log('Water layer removed');
                    waterLayerGroup.clearLayers();
                   if (waterYearControl) {
            map.removeControl(waterYearControl);
            waterYearControl = null;
        }
                }
            });

            // Store full GeoJSON data for agriculture
            let agricultureGeoJSONData = null;
            let currentAgricultureYear = 2024;

            // Function to load and visualize agriculture data from GeoJSON
            function loadAgricultureData() {
                // Fetch the agriculture GeoJSON data
                fetch('/agriculture/agriculture_data.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load agriculture data');
                        }
                        return response.json();
                    })
                    .then(geojsonData => {
                        agricultureGeoJSONData = geojsonData;

                        // Display agriculture data for the current year
                        displayAgricultureDataByYear(currentAgricultureYear);

                        // Create year selector control
                        agricultureYearControl  = L.control({position: 'topleft'});
                        agricultureYearControl .onAdd = function() {
                            const div = L.DomUtil.create('div', 'year-selector-agriculture');
                            div.innerHTML = `
                                <div style="background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 12px; font-family: sans-serif; min-width: 220px;">
                                    <strong style="font-size: 13px; display: block; margin-bottom: 8px;">üåæ Select Year</strong>
                                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        <button class="year-btn ag-2019" data-year="2019" style="padding: 6px 12px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2019</button>
                                        <button class="year-btn ag-2020" data-year="2020" style="padding: 6px 12px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2020</button>
                                        <button class="year-btn ag-2021" data-year="2021" style="padding: 6px 12px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2021</button>
                                        <button class="year-btn ag-2022" data-year="2022" style="padding: 6px 12px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2022</button>
                                        <button class="year-btn ag-2023" data-year="2023" style="padding: 6px 12px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2023</button>
                                        <button class="year-btn ag-2024 active" data-year="2024" style="padding: 6px 12px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2024</button>
                                    </div>
                                    <div id="ag-year-info" style="margin-top: 10px; padding: 8px; background: #f7fafc; border-radius: 6px; font-size: 11px;">
                                        <strong>Year: 2024</strong><br>
                                        <span id="ag-ndvi-display">NDVI: 0.72</span><br>
                                        <span id="ag-health-display">Status: Healthy</span>
                                    </div>
                                </div>
                            `;

                            // Add click handlers for year buttons
                            setTimeout(() => {
                                document.querySelectorAll('.year-btn').forEach(btn => {
                                    btn.addEventListener('click', function() {
                                        const year = parseInt(this.dataset.year);
                                        document.querySelectorAll('.year-btn').forEach(b => {
                                            b.style.background = 'white';
                                            b.style.color = '#667eea';
                                            b.style.borderWidth = '1px';
                                        });
                                        this.style.background = '#667eea';
                                        this.style.color = 'white';
                                        this.style.borderWidth = '2px';

                                        currentAgricultureYear = year;
                                        displayAgricultureDataByYear(year);
                                    });
                                });
                            }, 100);

                            return div;
                        };
                        agricultureYearControl.addTo(map);
                        


                        console.log('Agriculture GeoJSON data loaded successfully');
                    })
                    .catch(error => {
                        console.error('Error loading agriculture data:', error);
                        // Fallback: show current year data
                        const ndviValue = 0.72;
                        let color = '#1a9850';
                        if (ndviValue < 0.4) {
                            color = '#d73027';
                        } else if (ndviValue < 0.6) {
                            color = '#fee08b';
                        }

                        const fallbackPolygon = L.polygon(currentBoundary, {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.5,
                            weight: 2,
                            dashArray: '5, 5'
                        });

                        fallbackPolygon.bindPopup(`
                            <div style="font-family: sans-serif; min-width: 220px;">
                                <strong style="font-size: 14px; color: #2d3748;">üåæ Agriculture Data (2024)</strong><br><br>
                                <strong>Field:</strong> DEVLIYA_01<br>
                                <strong>Crop:</strong> Wheat<br>
                                <strong>Area:</strong> 0.44 hectares<br>
                                <strong>NDVI Index:</strong> ${ndviValue.toFixed(2)}<br>
                                <strong>Vegetation Status:</strong> <span style="color: ${color}; font-weight: bold;">
                                    üü¢ Healthy
                                </span><br>
                                <strong>Data Source:</strong> Sentinel-2 Satellite<br>
                            </div>
                        `);

                        agricultureLayerGroup.clearLayers();
                        agricultureLayerGroup.addLayer(fallbackPolygon);
                    });
            }

            // Function to display agriculture data for a specific year
            function displayAgricultureDataByYear(year) {
                if (!agricultureGeoJSONData) return;

                // Filter data for the selected year
                const yearData = agricultureGeoJSONData.features.find(f => f.properties.year === year);
                if (!yearData) return;

                const props = yearData.properties;
// Load NDVI raster (GeoTIFF)
if (props.filename) {
    loadAgricultureTif(props.filename);
}

                // Create GeoJSON layer for this year
                const geoJsonLayer = L.geoJSON(yearData, {
                    style: function(feature) {
                        const ndvi = feature.properties.ndvi;
                        let color = '#1a9850'; // Green for healthy
                        if (ndvi < 0.4) {
                            color = '#d73027'; // Red for stressed
                        } else if (ndvi < 0.6) {
                            color = '#fee08b'; // Yellow for moderate
                        }
                        return {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.5,
                            weight: 2,
                            dashArray: '5, 5'
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = `
                            <div style="font-family: sans-serif; min-width: 240px;">
                                <strong style="font-size: 14px; color: #2d3748;">üåæ Agriculture Data (${props.year})</strong><br><br>
                                <strong>Field:</strong> DEVLIYA_01<br>
                                <strong>Crop:</strong> Wheat<br>
                                <strong>Area:</strong> 0.44 hectares<br>
                                <strong>NDVI Index:</strong> <span style="color: ${props.color}; font-weight: bold;">${props.ndvi.toFixed(2)}</span><br>
                                <strong>Vegetation Status:</strong> <span style="color: ${props.color}; font-weight: bold;">
                                    ${props.ndvi > 0.6 ? 'üü¢ ' + props.health : props.ndvi > 0.4 ? 'üü° ' + props.health : 'üî¥ ' + props.health}
                                </span><br>
                                <strong>Data Source:</strong> ${props.filename}<br>
                                <strong>Satellite:</strong> Sentinel-2<br>
                            </div>
                        `;
                        layer.bindPopup(popupContent);
                    }
                });

                // Update the display
                const existingLayers = agricultureLayerGroup.getLayers();
                existingLayers.forEach(layer => {
                    if (layer instanceof L.GeoJSON) {
                        agricultureLayerGroup.removeLayer(layer);
                    }
                });
                agricultureLayerGroup.addLayer(geoJsonLayer);

                // Update year info display
                const infoDiv = document.getElementById('ag-year-info');
                if (infoDiv) {
                    infoDiv.innerHTML = `
                        <strong>Year: ${year}</strong><br>
                        <span id="ag-ndvi-display">NDVI: ${props.ndvi.toFixed(2)}</span><br>
                        <span id="ag-health-display">Status: ${props.health}</span>
                    `;
                }

                // Add legend if not already present
                const existingLegend = document.querySelector('.ag-legend');
                if (!existingLegend) {
                    const legendHtml = `
                        <div class="ag-legend" style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 12px; font-family: sans-serif;">
                            <strong style="font-size: 13px;">üåæ Agriculture Data</strong><br>
                            <div style="margin-top: 8px;">
                                <strong style="font-size: 11px;">NDVI Index:</strong><br>
                                <span style="display: inline-block; width: 16px; height: 16px; background: #d73027; border-radius: 2px; margin-right: 6px;"></span>Stressed (&lt;0.4)<br>
                                <span style="display: inline-block; width: 16px; height: 16px; background: #fee08b; border-radius: 2px; margin-right: 6px;"></span>Moderate (0.4-0.6)<br>
                                <span style="display: inline-block; width: 16px; height: 16px; background: #1a9850; border-radius: 2px; margin-right: 6px;"></span>Healthy (&gt;0.6)
                            </div>
                        </div>
                    `;

                    const legend = L.control({position: 'bottomright'});
                    legend.onAdd = function() {
                        const div = L.DomUtil.create('div');
                        div.innerHTML = legendHtml;
                        return div;
                    };
                    legend.addTo(map);
                }
            }

            // Store full GeoJSON data for water
            let waterGeoJSONData = null;
            let currentWaterYear = 2024;

            // Function to load and visualize water data from GeoJSON
            function loadWaterData() {
                // Fetch the water GeoJSON data
                fetch('/water/water_data.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load water data');
                        }
                        return response.json();
                    })
                    .then(geojsonData => {
                        waterGeoJSONData = geojsonData;

                        // Display water data for the current year
                        displayWaterDataByYear(currentWaterYear);

                        // Create year selector control
                        waterYearControl  = L.control({position: 'topleft'});
                        waterYearControl .onAdd = function() {
                            const div = L.DomUtil.create('div', 'year-selector-water');
                            div.innerHTML = `
                                <div style="background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 12px; font-family: sans-serif; min-width: 220px;">
                                    <strong style="font-size: 13px; display: block; margin-bottom: 8px;">üíß Select Year</strong>
                                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        <button class="year-btn w-2019" data-year="2019" style="padding: 6px 12px; border: 1px solid #3182ce; background: white; color: #3182ce; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2019</button>
                                        <button class="year-btn w-2020" data-year="2020" style="padding: 6px 12px; border: 1px solid #3182ce; background: white; color: #3182ce; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2020</button>
                                        <button class="year-btn w-2021" data-year="2021" style="padding: 6px 12px; border: 1px solid #3182ce; background: white; color: #3182ce; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2021</button>
                                        <button class="year-btn w-2022" data-year="2022" style="padding: 6px 12px; border: 1px solid #3182ce; background: white; color: #3182ce; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2022</button>
                                        <button class="year-btn w-2023" data-year="2023" style="padding: 6px 12px; border: 1px solid #3182ce; background: white; color: #3182ce; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2023</button>
                                        <button class="year-btn w-2024 active" data-year="2024" style="padding: 6px 12px; border: 2px solid #3182ce; background: #3182ce; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">2024</button>
                                    </div>
                                    <div id="w-year-info" style="margin-top: 10px; padding: 8px; background: #f7fafc; border-radius: 6px; font-size: 11px;">
                                        <strong>Year: 2024</strong><br>
                                        <span id="w-water-display">Water Index: 0.60</span><br>
                                        <span id="w-status-display">Status: Good</span>
                                    </div>
                                </div>
                            `;

                            // Add click handlers for year buttons
                            setTimeout(() => {
                                document.querySelectorAll('.year-btn').forEach(btn => {
                                    btn.addEventListener('click', function() {
                                        const year = parseInt(this.dataset.year);
                                        document.querySelectorAll('.year-btn').forEach(b => {
                                            b.style.background = 'white';
                                            b.style.color = '#3182ce';
                                            b.style.borderWidth = '1px';
                                        });
                                        this.style.background = '#3182ce';
                                        this.style.color = 'white';
                                        this.style.borderWidth = '2px';

                                        currentWaterYear = year;
                                        displayWaterDataByYear(year);
                                    });
                                });
                            }, 100);

                            return div;
                        };
                        waterYearControl.addTo(map);

                        console.log('Water GeoJSON data loaded successfully');
                    })
                    .catch(error => {
                        console.error('Error loading water data:', error);
                        // Fallback: show current year data
                        const waterValue = 0.60;
                        let color = '#2b6cb8';
                        if (waterValue < 0.3) {
                            color = '#74b9ff';
                        } else if (waterValue < 0.5) {
                            color = '#3182ce';
                        } else if (waterValue < 0.65) {
                            color = '#2b6cb8';
                        } else {
                            color = '#1d5a96';
                        }

                        const fallbackPolygon = L.polygon(currentBoundary, {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.5,
                            weight: 2,
                            dashArray: '5, 5'
                        });

                        fallbackPolygon.bindPopup(`
                            <div style="font-family: sans-serif; min-width: 220px;">
                                <strong style="font-size: 14px; color: #2d3748;">üíß Water Data (2024)</strong><br><br>
                                <strong>Field:</strong> DEVLIYA_01<br>
                                <strong>Crop:</strong> Wheat<br>
                                <strong>Area:</strong> 0.44 hectares<br>
                                <strong>Water Index:</strong> ${waterValue.toFixed(2)}<br>
                                <strong>Water Status:</strong> <span style="color: ${color}; font-weight: bold;">
                                    üíß Good
                                </span><br>
                                <strong>Data Source:</strong> Sentinel-2 Satellite<br>
                            </div>
                        `);

                        waterLayerGroup.clearLayers();
                        waterLayerGroup.addLayer(fallbackPolygon);
                    });
            }

            // Function to display water data for a specific year
            function displayWaterDataByYear(year) {
                if (!waterGeoJSONData) return;

                // Filter data for the selected year
                const yearData = waterGeoJSONData.features.find(f => f.properties.year === year);
                if (!yearData) return;

                const props = yearData.properties;

                // Create GeoJSON layer for this year
                const geoJsonLayer = L.geoJSON(yearData, {
                    style: function(feature) {
                        const waterIndex = feature.properties.water_index;
                        let color = '#1d5a96'; // Dark blue for excellent
                        if (waterIndex < 0.3) {
                            color = '#74b9ff'; // Light blue for low
                        } else if (waterIndex < 0.5) {
                            color = '#3182ce'; // Medium blue for moderate
                        } else if (waterIndex < 0.65) {
                            color = '#2b6cb8'; // Blue for good
                        }
                        return {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.5,
                            weight: 2,
                            dashArray: '5, 5'
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = `
                            <div style="font-family: sans-serif; min-width: 240px;">
                                <strong style="font-size: 14px; color: #2d3748;">üíß Water Data (${props.year})</strong><br><br>
                                <strong>Field:</strong> DEVLIYA_01<br>
                                <strong>Crop:</strong> Wheat<br>
                                <strong>Area:</strong> 0.44 hectares<br>
                                <strong>Water Index:</strong> <span style="color: ${props.color}; font-weight: bold;">${props.water_index.toFixed(2)}</span><br>
                                <strong>Water Status:</strong> <span style="color: ${props.color}; font-weight: bold;">
                                    ${props.water_index > 0.6 ? 'üåä ' + props.status : props.water_index > 0.45 ? 'üíß ' + props.status : '‚ö†Ô∏è ' + props.status}
                                </span><br>
                                <strong>Data Source:</strong> ${props.filename}<br>
                                <strong>Satellite:</strong> Sentinel-2<br>
                            </div>
                        `;
                        layer.bindPopup(popupContent);
                    }
                });

                // Update the display
                const existingLayers = waterLayerGroup.getLayers();
                existingLayers.forEach(layer => {
                    if (layer instanceof L.GeoJSON) {
                        waterLayerGroup.removeLayer(layer);
                    }
                });
                waterLayerGroup.addLayer(geoJsonLayer);

                // Update year info display
                const infoDiv = document.getElementById('w-year-info');
                if (infoDiv) {
                    infoDiv.innerHTML = `
                        <strong>Year: ${year}</strong><br>
                        <span id="w-water-display">Water Index: ${props.water_index.toFixed(2)}</span><br>
                        <span id="w-status-display">Status: ${props.status}</span>
                    `;
                }

                // Add legend if not already present
                const existingLegend = document.querySelector('.w-legend');
                if (!existingLegend) {
                    const legendHtml = `
                        <div class="w-legend" style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 12px; font-family: sans-serif;">
                            <strong style="font-size: 13px;">üíß Water Data</strong><br>
                            <div style="margin-top: 8px;">
                                <strong style="font-size: 11px;">Water Index:</strong><br>
                                <span style="display: inline-block; width: 16px; height: 16px; background: #74b9ff; border-radius: 2px; margin-right: 6px;"></span>Low (&lt;0.3)<br>
                                <span style="display: inline-block; width: 16px; height: 16px; background: #3182ce; border-radius: 2px; margin-right: 6px;"></span>Moderate (0.3-0.5)<br>
                                <span style="display: inline-block; width: 16px; height: 16px; background: #2b6cb8; border-radius: 2px; margin-right: 6px;"></span>Good (0.5-0.65)<br>
                                <span style="display: inline-block; width: 16px; height: 16px; background: #1d5a96; border-radius: 2px; margin-right: 6px;"></span>Excellent (&gt;0.65)
                            </div>
                        </div>
                    `;

                    const legend = L.control({position: 'bottomright'});
                    legend.onAdd = function() {
                        const div = L.DomUtil.create('div');
                        div.innerHTML = legendHtml;
                        return div;
                    };
                    legend.addTo(map);
                }
            }

            // Define field boundary coordinates for different map providers (0.44 hectares)
            // Esri and OSM use these coordinates
            const fieldBoundaryDefault = [
                [27.1183317, 75.4404729],
                [27.1184106, 75.4410016],
                [27.1178556, 75.4410973],
                [27.1178580, 75.4408724],
                [27.1177145, 75.4408652],
                [27.1177193, 75.4407480],
                [27.1175901, 75.4407360],
                [27.1175877, 75.4404944]
            ];

            // Google Satellite uses these coordinates
            const fieldBoundaryGoogle = [
                [27.1183317, 75.4405229],
                [27.1184106, 75.4410516],
                [27.1178556, 75.4411473],
                [27.1178580, 75.4409224],
                [27.1177145, 75.4409152],
                [27.1177193, 75.4407980],
                [27.1175901, 75.4407860],
                [27.1175877, 75.4405444]
            ];

            // Start with default boundary
            let currentBoundary = fieldBoundaryDefault;

            // Add field boundary polygon
            let normalPolygon = L.polygon(currentBoundary, {
                color: '#667eea',
                fillColor: '#667eea',
                fillOpacity: 0.4,
                weight: 3
            }).addTo(map);

            // Add field label marker (positioned to avoid overlap)
            const fieldMarker = L.marker([27.1184000, 75.4405000], {
                icon: L.divIcon({
                    className: 'field-label-marker',
                    html: `<div style="background: white; padding: 8px 14px; border-radius: 8px;
                           box-shadow: 0 2px 12px rgba(0,0,0,0.25); font-weight: 600;
                           font-size: 13px; white-space: nowrap; border: 2px solid #667eea;">
                           <div style="color: #2d3748;">DEVLIYA_01</div>
                           <small style="color: #718096; font-weight: 500;">Wheat Field</small>
                           </div>`,
                    iconSize: [140, 50],
                    iconAnchor: [70, 65]
                })
            }).addTo(map);

            // Add popup to field boundary
            normalPolygon.bindPopup(`
                <div style="font-family: sans-serif; min-width: 200px;">
                    <strong style="font-size: 15px; color: #2d3748;">Field: DEVLIYA_01</strong><br><br>
                    <strong>Crop:</strong> Wheat üåæ<br>
                    <strong>Area:</strong> 0.44 hectares<br>
                    <strong>Location:</strong> Devliya, Jaipur<br>
                    <strong>NDVI:</strong> 0.72 (Healthy) üü¢
                </div>
            `);

            // Fit map to field boundary with padding
            setTimeout(() => {
                map.fitBounds(normalPolygon.getBounds(), {
                    padding: [80, 80]
                });
            }, 100);

            // Force map to redraw
            setTimeout(() => {
                map.invalidateSize();
            }, 200);

            console.log('Map initialized successfully at Devliya, Jaipur');

            // ========== LINE CHART FOR WEATHER DATA ==========

            // Load monthly weather from CSV (fallback to embedded data)
            const WEATHER_CSV_CANDIDATES = ['/open-meteo-27.17N75.37E411m.csv','../open-meteo-27.17N75.37E411m.csv'];
            let weatherData = [];
            function fetchCSVWithFallback(p,i=0){if(i>=p.length)return Promise.reject(new Error('CSV not found'));return fetch(p[i]).then(r=>{if(!r.ok)throw new Error('Failed '+p[i]);return r.text()}).catch(()=>fetchCSVWithFallback(p,i+1))}
            function csvParse(t){const lines=t.split('\n').filter(l=>l.trim());const hIdx=lines.findIndex(l=>l.startsWith('time,'));const h=lines[hIdx].split(',');const idx={time:h.indexOf('time'),temperature:h.indexOf('temperature_2m (¬∞C)'),humidity:h.indexOf('relative_humidity_2m (%)'),precipitation:h.indexOf('precipitation (mm)'),rain:h.indexOf('rain (mm)'),wind_speed:h.indexOf('wind_speed_10m (km/h)'),cloud_cover:h.indexOf('cloud_cover (%)'),et0:h.indexOf('et0_fao_evapotranspiration (mm)'),pressure:h.indexOf('surface_pressure (hPa)')};const rows=[];for(let i=hIdx+1;i<lines.length;i++)rows.push(lines[i].split(','));return{idx,rows}}
            function aggregateMonthly(p){const{idx,rows}=p;const b={};for(const r of rows){const m=r[idx.time].slice(0,7);const x=b[m]||(b[m]={c:0,T:0,H:0,W:0,CC:0,ET0:0,P:0,R:0,PR:0});x.c++;x.T+=parseFloat(r[idx.temperature]||0);x.H+=parseFloat(r[idx.humidity]||0);x.W+=parseFloat(r[idx.wind_speed]||0);x.CC+=parseFloat(r[idx.cloud_cover]||0);x.ET0+=parseFloat(r[idx.et0]||0);x.P+=parseFloat(r[idx.pressure]||0);x.R+=parseFloat(r[idx.rain]||0);x.PR+=parseFloat(r[idx.precipitation]||0)}return Object.keys(b).sort().map(m=>{const x=b[m];return{date:m,temperature:+(x.T/x.c).toFixed(2),humidity:+(x.H/x.c).toFixed(2),wind_speed:+(x.W/x.c).toFixed(2),rain:+x.R.toFixed(1),precipitation:+x.PR.toFixed(1),cloud_cover:+(x.CC/x.c).toFixed(2),evapotranspiration:+(x.ET0/x.c).toFixed(2),soil_moisture:0.0,pressure:+(x.P/x.c).toFixed(2)}})}
            fetchCSVWithFallback(WEATHER_CSV_CANDIDATES).then(t=>{const p=csvParse(t);weatherData=aggregateMonthly(p);updateChartWithPeriod('month')}).catch(e=>{console.warn('CSV load failed, using embedded fallback',e);weatherData=weatherDataFallback;updateChartWithPeriod('month')});
            const weatherDataFallback = [
                {"date": "2019-11", "temperature": -0.58, "humidity": 75.37, "wind_speed": 30.88, "rain": 5.4, "precipitation": 83.7, "cloud_cover": 86.21, "evapotranspiration": 17.86, "soil_moisture": 0.0, "pressure": 1012.73},
                {"date": "2019-12", "temperature": -1.39, "humidity": 78.88, "wind_speed": 37.39, "rain": 13.3, "precipitation": 114.8, "cloud_cover": 86.19, "evapotranspiration": 16.92, "soil_moisture": 0.0, "pressure": 998.45},
                {"date": "2020-01", "temperature": -6.07, "humidity": 73.93, "wind_speed": 36.68, "rain": 8.1, "precipitation": 62.7, "cloud_cover": 91.96, "evapotranspiration": 16.34, "soil_moisture": 0.0, "pressure": 998.34},
                {"date": "2020-02", "temperature": -5.57, "humidity": 77.59, "wind_speed": 37.59, "rain": 1.0, "precipitation": 85.1, "cloud_cover": 93.39, "evapotranspiration": 12.8, "soil_moisture": 0.0, "pressure": 984.76},
                {"date": "2020-03", "temperature": -7.32, "humidity": 78.26, "wind_speed": 31.89, "rain": 8.0, "precipitation": 65.8, "cloud_cover": 89.84, "evapotranspiration": 14.99, "soil_moisture": 0.0, "pressure": 997.96},
                {"date": "2020-04", "temperature": -4.75, "humidity": 78.44, "wind_speed": 31.64, "rain": 1.4, "precipitation": 42.5, "cloud_cover": 84.4, "evapotranspiration": 22.3, "soil_moisture": 0.0, "pressure": 1007.77},
                {"date": "2020-05", "temperature": 0.33, "humidity": 86.45, "wind_speed": 25.37, "rain": 11.8, "precipitation": 45.5, "cloud_cover": 84.16, "evapotranspiration": 32.3, "soil_moisture": 0.0, "pressure": 1010.59},
                {"date": "2020-06", "temperature": 2.06, "humidity": 90.87, "wind_speed": 25.44, "rain": 14.6, "precipitation": 17.2, "cloud_cover": 87.99, "evapotranspiration": 34.35, "soil_moisture": 0.0, "pressure": 1013.21},
                {"date": "2020-07", "temperature": 5.17, "humidity": 95.46, "wind_speed": 21.6, "rain": 45.0, "precipitation": 45.0, "cloud_cover": 90.41, "evapotranspiration": 33.25, "soil_moisture": 0.0, "pressure": 1010.23},
                {"date": "2020-08", "temperature": 6.34, "humidity": 90.14, "wind_speed": 23.7, "rain": 68.1, "precipitation": 68.1, "cloud_cover": 86.53, "evapotranspiration": 29.53, "soil_moisture": 0.0, "pressure": 1005.96},
                {"date": "2020-09", "temperature": 4.88, "humidity": 86.68, "wind_speed": 22.83, "rain": 38.1, "precipitation": 38.4, "cloud_cover": 80.49, "evapotranspiration": 18.22, "soil_moisture": 0.0, "pressure": 1002.9},
                {"date": "2020-10", "temperature": 2.01, "humidity": 78.78, "wind_speed": 26.3, "rain": 20.4, "precipitation": 31.9, "cloud_cover": 91.15, "evapotranspiration": 18.72, "soil_moisture": 0.0, "pressure": 1014.77},
                {"date": "2020-11", "temperature": 1.22, "humidity": 81.65, "wind_speed": 31.92, "rain": 43.5, "precipitation": 93.0, "cloud_cover": 88.74, "evapotranspiration": 13.27, "soil_moisture": 0.0, "pressure": 997.53},
                {"date": "2020-12", "temperature": -1.17, "humidity": 71.67, "wind_speed": 37.76, "rain": 4.4, "precipitation": 79.5, "cloud_cover": 84.72, "evapotranspiration": 23.41, "soil_moisture": 0.0, "pressure": 1013.72},
                {"date": "2021-01", "temperature": -2.03, "humidity": 74.55, "wind_speed": 32.62, "rain": 8.7, "precipitation": 58.9, "cloud_cover": 79.97, "evapotranspiration": 18.41, "soil_moisture": 0.0, "pressure": 1017.11},
                {"date": "2021-02", "temperature": -3.61, "humidity": 72.31, "wind_speed": 30.39, "rain": 2.9, "precipitation": 40.8, "cloud_cover": 87.21, "evapotranspiration": 16.53, "soil_moisture": 0.0, "pressure": 1018.21},
                {"date": "2021-03", "temperature": -3.67, "humidity": 76.45, "wind_speed": 30.78, "rain": 7.5, "precipitation": 63.3, "cloud_cover": 88.18, "evapotranspiration": 18.31, "soil_moisture": 0.0, "pressure": 999.82},
                {"date": "2021-04", "temperature": -2.0, "humidity": 76.82, "wind_speed": 30.71, "rain": 4.8, "precipitation": 96.6, "cloud_cover": 88.15, "evapotranspiration": 25.96, "soil_moisture": 0.0, "pressure": 1005.17},
                {"date": "2021-05", "temperature": -0.8, "humidity": 73.71, "wind_speed": 26.89, "rain": 4.8, "precipitation": 34.1, "cloud_cover": 85.29, "evapotranspiration": 41.61, "soil_moisture": 0.0, "pressure": 1016.03},
                {"date": "2021-06", "temperature": 2.39, "humidity": 91.89, "wind_speed": 25.76, "rain": 50.9, "precipitation": 60.7, "cloud_cover": 81.2, "evapotranspiration": 34.09, "soil_moisture": 0.0, "pressure": 1007.51},
                {"date": "2021-07", "temperature": 3.45, "humidity": 93.01, "wind_speed": 22.33, "rain": 36.3, "precipitation": 36.3, "cloud_cover": 85.35, "evapotranspiration": 33.46, "soil_moisture": 0.0, "pressure": 1005.78},
                {"date": "2021-08", "temperature": 5.14, "humidity": 89.67, "wind_speed": 21.61, "rain": 65.8, "precipitation": 65.8, "cloud_cover": 90.09, "evapotranspiration": 27.86, "soil_moisture": 0.0, "pressure": 1011.67},
                {"date": "2021-09", "temperature": 4.1, "humidity": 87.04, "wind_speed": 26.37, "rain": 22.3, "precipitation": 22.3, "cloud_cover": 88.62, "evapotranspiration": 17.43, "soil_moisture": 0.0, "pressure": 1013.24},
                {"date": "2021-10", "temperature": 1.05, "humidity": 78.65, "wind_speed": 33.68, "rain": 44.4, "precipitation": 84.0, "cloud_cover": 84.66, "evapotranspiration": 20.25, "soil_moisture": 0.0, "pressure": 1008.08},
                {"date": "2021-11", "temperature": -3.2, "humidity": 71.72, "wind_speed": 33.44, "rain": 6.2, "precipitation": 84.8, "cloud_cover": 93.87, "evapotranspiration": 19.33, "soil_moisture": 0.0, "pressure": 1005.34},
                {"date": "2021-12", "temperature": -2.5, "humidity": 78.5, "wind_speed": 31.21, "rain": 0.7, "precipitation": 46.3, "cloud_cover": 86.22, "evapotranspiration": 13.87, "soil_moisture": 0.0, "pressure": 1011.3},
                {"date": "2022-01", "temperature": -4.44, "humidity": 78.42, "wind_speed": 34.21, "rain": 8.5, "precipitation": 80.4, "cloud_cover": 90.56, "evapotranspiration": 13.83, "soil_moisture": 0.0, "pressure": 993.84},
                {"date": "2022-02", "temperature": -3.49, "humidity": 76.0, "wind_speed": 29.84, "rain": 0.5, "precipitation": 49.1, "cloud_cover": 86.96, "evapotranspiration": 14.18, "soil_moisture": 0.0, "pressure": 995.58},
                {"date": "2022-03", "temperature": -1.84, "humidity": 79.74, "wind_speed": 38.51, "rain": 17.0, "precipitation": 85.4, "cloud_cover": 87.23, "evapotranspiration": 19.76, "soil_moisture": 0.0, "pressure": 1009.94},
                {"date": "2022-04", "temperature": -4.31, "humidity": 81.89, "wind_speed": 31.48, "rain": 10.4, "precipitation": 78.5, "cloud_cover": 95.97, "evapotranspiration": 19.25, "soil_moisture": 0.0, "pressure": 1012.63},
                {"date": "2022-05", "temperature": -1.89, "humidity": 84.24, "wind_speed": 26.85, "rain": 1.6, "precipitation": 17.7, "cloud_cover": 80.65, "evapotranspiration": 33.1, "soil_moisture": 0.0, "pressure": 1011.38},
                {"date": "2022-06", "temperature": 3.51, "humidity": 89.4, "wind_speed": 23.06, "rain": 50.7, "precipitation": 55.7, "cloud_cover": 89.96, "evapotranspiration": 36.87, "soil_moisture": 0.0, "pressure": 1013.44},
                {"date": "2022-07", "temperature": 6.87, "humidity": 92.76, "wind_speed": 20.57, "rain": 73.0, "precipitation": 73.0, "cloud_cover": 93.06, "evapotranspiration": 38.35, "soil_moisture": 0.0, "pressure": 1011.83},
                {"date": "2022-08", "temperature": 7.14, "humidity": 87.82, "wind_speed": 22.68, "rain": 56.2, "precipitation": 56.2, "cloud_cover": 90.28, "evapotranspiration": 33.41, "soil_moisture": 0.0, "pressure": 1009.95},
                {"date": "2022-09", "temperature": 4.57, "humidity": 83.61, "wind_speed": 26.97, "rain": 37.3, "precipitation": 45.7, "cloud_cover": 90.93, "evapotranspiration": 22.59, "soil_moisture": 0.0, "pressure": 1015.89},
                {"date": "2022-10", "temperature": 2.26, "humidity": 80.13, "wind_speed": 28.3, "rain": 40.7, "precipitation": 82.2, "cloud_cover": 91.36, "evapotranspiration": 18.11, "soil_moisture": 0.0, "pressure": 1000.15},
                {"date": "2022-11", "temperature": 1.69, "humidity": 85.11, "wind_speed": 22.62, "rain": 18.2, "precipitation": 35.9, "cloud_cover": 91.28, "evapotranspiration": 7.01, "soil_moisture": 0.0, "pressure": 1013.6},
                {"date": "2022-12", "temperature": -1.8, "humidity": 75.37, "wind_speed": 32.93, "rain": 9.2, "precipitation": 57.2, "cloud_cover": 91.09, "evapotranspiration": 17.21, "soil_moisture": 0.0, "pressure": 1010.68},
                {"date": "2023-01", "temperature": 0.35, "humidity": 78.48, "wind_speed": 36.66, "rain": 22.0, "precipitation": 85.9, "cloud_cover": 90.64, "evapotranspiration": 18.48, "soil_moisture": 0.0, "pressure": 998.6},
                {"date": "2023-02", "temperature": -1.57, "humidity": 74.45, "wind_speed": 36.14, "rain": 29.3, "precipitation": 68.4, "cloud_cover": 84.72, "evapotranspiration": 18.58, "soil_moisture": 0.0, "pressure": 996.79},
                {"date": "2023-03", "temperature": -7.47, "humidity": 77.7, "wind_speed": 37.64, "rain": 0.5, "precipitation": 96.0, "cloud_cover": 95.34, "evapotranspiration": 16.08, "soil_moisture": 0.0, "pressure": 1002.91},
                {"date": "2023-04", "temperature": -1.5, "humidity": 84.4, "wind_speed": 31.92, "rain": 16.7, "precipitation": 38.2, "cloud_cover": 89.01, "evapotranspiration": 21.95, "soil_moisture": 0.0, "pressure": 1018.22},
                {"date": "2023-05", "temperature": 0.79, "humidity": 87.35, "wind_speed": 28.91, "rain": 31.8, "precipitation": 56.2, "cloud_cover": 88.79, "evapotranspiration": 30.99, "soil_moisture": 0.0, "pressure": 1008.04},
                {"date": "2023-06", "temperature": 3.18, "humidity": 86.38, "wind_speed": 21.47, "rain": 8.9, "precipitation": 10.2, "cloud_cover": 82.1, "evapotranspiration": 47.2, "soil_moisture": 0.0, "pressure": 1014.35},
                {"date": "2023-07", "temperature": 5.17, "humidity": 88.88, "wind_speed": 24.79, "rain": 16.1, "precipitation": 16.1, "cloud_cover": 90.13, "evapotranspiration": 40.99, "soil_moisture": 0.0, "pressure": 1013.34},
                {"date": "2023-08", "temperature": 7.05, "humidity": 91.83, "wind_speed": 23.37, "rain": 25.0, "precipitation": 25.0, "cloud_cover": 91.81, "evapotranspiration": 28.65, "soil_moisture": 0.0, "pressure": 1013.71},
                {"date": "2023-09", "temperature": 4.68, "humidity": 81.81, "wind_speed": 27.4, "rain": 60.3, "precipitation": 88.8, "cloud_cover": 87.38, "evapotranspiration": 24.92, "soil_moisture": 0.0, "pressure": 1006.1},
                {"date": "2023-10", "temperature": 0.92, "humidity": 74.07, "wind_speed": 34.19, "rain": 17.4, "precipitation": 66.4, "cloud_cover": 86.24, "evapotranspiration": 24.88, "soil_moisture": 0.0, "pressure": 1006.81},
                {"date": "2023-11", "temperature": -1.64, "humidity": 75.75, "wind_speed": 29.33, "rain": 2.1, "precipitation": 45.0, "cloud_cover": 90.65, "evapotranspiration": 16.09, "soil_moisture": 0.0, "pressure": 1011.65},
                {"date": "2023-12", "temperature": -0.64, "humidity": 76.07, "wind_speed": 36.48, "rain": 4.3, "precipitation": 74.8, "cloud_cover": 90.12, "evapotranspiration": 21.4, "soil_moisture": 0.0, "pressure": 1006.14},
                {"date": "2024-01", "temperature": -5.42, "humidity": 78.68, "wind_speed": 36.02, "rain": 3.0, "precipitation": 82.7, "cloud_cover": 88.86, "evapotranspiration": 14.49, "soil_moisture": 0.0, "pressure": 1001.08},
                {"date": "2024-02", "temperature": -1.59, "humidity": 76.03, "wind_speed": 34.12, "rain": 7.5, "precipitation": 53.1, "cloud_cover": 89.12, "evapotranspiration": 17.95, "soil_moisture": 0.0, "pressure": 997.48},
                {"date": "2024-03", "temperature": -6.9, "humidity": 84.36, "wind_speed": 28.44, "rain": 5.4, "precipitation": 44.9, "cloud_cover": 94.96, "evapotranspiration": 10.44, "soil_moisture": 0.0, "pressure": 1013.18},
                {"date": "2024-04", "temperature": -3.94, "humidity": 79.42, "wind_speed": 29.3, "rain": 2.0, "precipitation": 22.9, "cloud_cover": 94.97, "evapotranspiration": 24.14, "soil_moisture": 0.0, "pressure": 1019.11}
            ];

            // Column configuration with colors
            const columnConfig = {
                temperature: { label: 'Temperature (C)', color: '#e53e3e', borderColor: '#e53e3e' },
                humidity: { label: 'Humidity (%)', color: '#3182ce', borderColor: '#3182ce' },
                precipitation: { label: 'Precipitation (mm)', color: '#38a169', borderColor: '#38a169' },
                rain: { label: 'Rain (mm)', color: '#667eea', borderColor: '#667eea' },
                wind_speed: { label: 'Wind Speed (km/h)', color: '#805ad5', borderColor: '#805ad5' },
                cloud_cover: { label: 'Cloud Cover (%)', color: '#718096', borderColor: '#718096' },
                evapotranspiration: { label: 'ET0 (mm)', color: '#d69e2e', borderColor: '#d69e2e' },
                pressure: { label: 'Pressure (hPa)', color: '#ed8936', borderColor: '#ed8936' }
            };

            // Extract labels (months)
            const labels = weatherData.map(d => d.date);

            // Function to create dataset for a column
            function createDataset(columnKey) {
                const config = columnConfig[columnKey];
                return {
                    label: config.label,
                    data: weatherData.map(d => d[columnKey]),
                    borderColor: config.borderColor,
                    backgroundColor: config.color + '33',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 2,
                    pointHoverRadius: 5
                };
            }

            // Get initially checked columns
            function getSelectedColumns() {
                const checkboxes = document.querySelectorAll('.column-checkboxes input[type="checkbox"]:checked');
                return Array.from(checkboxes).map(cb => cb.value);
            }

            // Initialize chart
            const ctx = document.getElementById('weatherChart').getContext('2d');
            let weatherChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: getSelectedColumns().map(col => createDataset(col))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(45, 55, 72, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Month (YYYY-MM)',
                                color: '#4a5568',
                                font: { weight: 'bold', size: 12 }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                maxRotation: 90,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 20,
                                color: '#4a5568',
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value',
                                color: '#4a5568',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });

            document.querySelectorAll('.column-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const selectedColumns = getSelectedColumns();
                    const labels = weatherChart.data.labels;
                    weatherChart.data.datasets = selectedColumns.map(k => {
                        const c = columnConfig[k];
                        return {
                            label: c.label,
                            data: labels.map(L => {
                                const d = filteredData.find(x => x.date === L);
                                return d ? d[k] : null;
                            }),
                            borderColor: c.borderColor,
                            backgroundColor: c.color + '33',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        };
                    });
                    weatherChart.update();
                    updateStats(filteredData);
                });
            });

            // Time period filter functionality
            let currentPeriod = 'all';
            let filteredData = weatherData;

            function filterDataByPeriod(period) {
                const now = new Date('2024-04-30'); // Last date in dataset
                let filtered = [];

                if (period === 'week') {
                    // Get last 7 days (convert monthly data to show last entries)
                    filtered = weatherData.slice(-1); // Show last month for demo
                } else if (period === 'month') {
                    // Get last 12 months
                    filtered = weatherData.slice(-12);
                } else if (period === 'year') {
                    // Show all data
                    filtered = weatherData;
                }

                return filtered;
            }

            function updateChartWithPeriod(period) {
                currentPeriod = period;
                filteredData = filterDataByPeriod(period);
                weatherChart.data.labels = filteredData.map(d => d.date);
                weatherChart.data.datasets = getSelectedColumns().map(columnKey => {
                    const config = columnConfig[columnKey];
                    return {
                        label: config.label,
                        data: filteredData.map(d => d[columnKey]),
                        borderColor: config.borderColor,
                        backgroundColor: config.color + '33',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    };
                });
                weatherChart.update();
                updateStats(filteredData);
            }

            // Add event listeners to period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const period = this.getAttribute('data-period');
                    updateChartWithPeriod(period);
                });
            });

            // Initialize with month view
            updateChartWithPeriod('month');

            function setupDateRangeControls(){const m=weatherData.map(d=>d.date);if(!m.length)return;const min=m[0],max=m[m.length-1];const s=document.getElementById('startMonth'),e=document.getElementById('endMonth');if(!s||!e)return;s.min=min;s.max=max;e.min=min;e.max=max;if(!s.value)s.value=min;if(!e.value)e.value=max;} 
            function updateStats(data){const s=document.getElementById('statsContent');if(!s){return;}const cols=getSelectedColumns();let html='';for(const k of cols){const vals=data.map(d=>d[k]).filter(v=>typeof v==='number'&&!isNaN(v));if(!vals.length)continue;const mn=Math.min(...vals),mx=Math.max(...vals);const label=columnConfig[k].label;html+=`<div style="margin-bottom:6px;"><strong>${label}</strong><br><span>min: ${mn.toFixed(2)}</span> ‚Ä¢ <span>max: ${mx.toFixed(2)}</span></div>`;}s.innerHTML=html||'No data';}
            function updateChartWithRange(s,e){filteredData=weatherData.filter(d=>d.date>=s&&d.date<=e);weatherChart.data.labels=filteredData.map(d=>d.date);weatherChart.data.datasets=getSelectedColumns().map(k=>{const c=columnConfig[k];return{label:c.label,data:filteredData.map(d=>d[k]),borderColor:c.borderColor,backgroundColor:c.color+'33',fill:false,tension:0.3,pointRadius:2,pointHoverRadius:5};});weatherChart.update();updateStats(filteredData);} 
            const _s=document.getElementById('startMonth'),_e=document.getElementById('endMonth');
            document.getElementById('applyRange')?.addEventListener('click',()=>{if(!_s||!_e||!_s.value||!_e.value)return;const a=_s.value<=_e.value?_s.value:_e.value;const b=_e.value>=_s.value?_e.value:_s.value;updateChartWithRange(a,b);});
            document.getElementById('resetRange')?.addEventListener('click',()=>updateChartWithPeriod('year'));
            setupDateRangeControls();

            console.log('Weather chart initialized with', weatherData.length, 'data points');
        });
    </script>
    
</body>
</html>